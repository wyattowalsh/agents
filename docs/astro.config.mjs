import { defineConfig } from 'astro/config';
import { fileURLToPath } from 'node:url';
import starlight from '@astrojs/starlight';
import starlightThemeBlack from 'starlight-theme-black';
import starlightSiteGraph from 'starlight-site-graph';
import starlightLinksValidator from 'starlight-links-validator';
import starlightLlmsTxt from 'starlight-llms-txt';
// Generated by `wagents docs generate` â€” run it before dev/build
import generatedSidebar, { navLinks } from './src/generated-sidebar.mjs';

const siteGraphMicromatchShimPath = fileURLToPath(
  new URL('./src/vendor/micromatch-lite.ts', import.meta.url)
);

export default defineConfig({
  site: 'https://agents.w4w.dev',
  vite: {
    plugins: [
      {
        name: 'starlight-site-graph-micromatch-shim',
        enforce: 'pre',
        resolveId(id, importer) {
          if (id !== 'micromatch' || !importer) return null;
          const normalizedImporter = importer.replaceAll('\\', '/');
          if (!normalizedImporter.includes('/node_modules/starlight-site-graph/')) return null;
          return siteGraphMicromatchShimPath;
        },
      },
    ],
    resolve: {
      alias: {
        'starlight-theme-black/overrides/PageSidebar.astro': fileURLToPath(
          new URL('./src/components/starlight/PageSidebarComposed.astro', import.meta.url)
        ),
        'starlight-site-graph/internal/PageGraph.astro': fileURLToPath(
          new URL('./node_modules/starlight-site-graph/components/graph/PageGraph.astro', import.meta.url)
        ),
        'starlight-site-graph/internal/PageBacklinks.astro': fileURLToPath(
          new URL('./node_modules/starlight-site-graph/components/backlinks/PageBacklinks.astro', import.meta.url)
        ),
      },
    },
  },
  integrations: [
    starlight({
      title: 'wyattowalsh/agents | AI Agent Configs',
      description: 'AI agent skills, tools, and MCP servers for Claude Code, Gemini CLI, Codex, Cursor, and more',
      editLink: { baseUrl: 'https://github.com/wyattowalsh/agents/edit/main/docs/' },
      lastUpdated: true,
      plugins: [
        starlightThemeBlack({
          navLinks,
        }),
        starlightLinksValidator(),
        starlightLlmsTxt(),
        starlightSiteGraph({
          overridePageSidebar: false,
          graphConfig: {
            depth: 2,
            renderArrows: true,
            enableZoom: true,
            enablePan: true,
            enableDrag: true,
            enableHover: true,
            enableClick: 'auto',
            actions: ['fullscreen', 'depth', 'reset-zoom'],
          },
          sitemapConfig: { includeExternalLinks: false },
        }),
      ],
      social: [{ icon: 'github', label: 'GitHub', href: 'https://github.com/wyattowalsh/agents' }],
      customCss: [
        '@fontsource/geist-sans/400.css',
        '@fontsource/geist-sans/500.css',
        '@fontsource/geist-sans/600.css',
        '@fontsource/geist-sans/700.css',
        '@fontsource/geist-mono/400.css',
        './src/styles/00-tokens.css',
        './src/styles/10-base.css',
        './src/styles/20-hero.css',
        './src/styles/30-cards.css',
        './src/styles/40-content.css',
        './src/styles/50-layout-nav.css',
        './src/styles/60-motion.css',
        './src/styles/70-a11y.css',
      ],
      components: {
        Head: './src/components/starlight/Head.astro',
      },
      sidebar: generatedSidebar,
    }),
  ],
});
