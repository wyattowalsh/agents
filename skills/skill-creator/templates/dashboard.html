<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Skill Dashboard</title>
<style>
/* ==========================================================================
   Design System — HSL Custom Properties
   ========================================================================== */

:root {
  --bg: 222 47% 6%;
  --card: 222 30% 10%;
  --card-hover: 222 30% 13%;
  --border: 215 20% 20%;
  --text: 210 40% 96%;
  --text-muted: 215 20% 55%;
  --accent: 238 80% 67%;
  --accent-glow: 238 80% 67% / 0.15;
  --grade-a: 160 60% 45%;
  --grade-b: 238 80% 67%;
  --grade-c: 38 92% 50%;
  --grade-d: 25 95% 53%;
  --grade-f: 0 84% 60%;
  --status-pending: 215 20% 40%;
  --status-active: 238 80% 67%;
  --status-completed: 160 60% 45%;
  --status-failed: 0 84% 60%;
  --status-skipped: 215 15% 55%;
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --radius-full: 9999px;
}

[data-theme="light"] {
  --bg: 210 20% 98%;
  --card: 0 0% 100%;
  --card-hover: 210 15% 96%;
  --border: 215 15% 85%;
  --text: 222 47% 11%;
  --text-muted: 215 15% 45%;
  --status-pending: 215 15% 55%;
  --status-active: 238 75% 55%;
  --status-completed: 160 55% 38%;
  --status-failed: 0 78% 50%;
  --status-skipped: 215 12% 60%;
}

/* Grade color mapping via data attributes */
[data-grade="A"] { --grade: var(--grade-a); }
[data-grade="B"] { --grade: var(--grade-b); }
[data-grade="C"] { --grade: var(--grade-c); }
[data-grade="D"] { --grade: var(--grade-d); }
[data-grade="F"] { --grade: var(--grade-f); }

/* ==========================================================================
   Reset & Base
   ========================================================================== */

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
  background: hsl(var(--bg));
  color: hsl(var(--text));
  line-height: 1.5;
  padding: 1.5rem;
  max-width: 1200px;
  margin: 0 auto;
  min-height: 100vh;
}

/* Ambient mesh gradient background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  z-index: -1;
  background:
    radial-gradient(ellipse at 20% 50%, hsl(var(--accent) / 0.06) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 20%, hsl(160 60% 50% / 0.04) 0%, transparent 50%);
  pointer-events: none;
}

h1, h2, h3 { font-weight: 600; }
h1 { font-size: 1.5rem; letter-spacing: -0.02em; }
h2 { font-size: 1.15rem; }
h3 { font-size: 0.95rem; }

/* ==========================================================================
   Components — Cards
   ========================================================================== */

.card {
  background: hsl(var(--card) / 0.7);
  backdrop-filter: blur(12px) saturate(1.2);
  border: 1px solid hsl(var(--border) / 0.5);
  border-radius: var(--radius-md);
  padding: 1rem;
  box-shadow:
    0 1px 2px hsl(0 0% 0% / 0.05),
    0 4px 16px hsl(0 0% 0% / 0.08);
}

.skill-card {
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.3s ease;
  animation: fadeSlideUp 0.4s ease both;
  animation-delay: calc(var(--i, 0) * 60ms);
}

.skill-card:hover {
  box-shadow:
    0 0 0 1px hsl(var(--grade) / 0.3),
    0 8px 32px hsl(var(--grade) / 0.12);
  transform: translateY(-2px);
}

.skill-card:focus-visible {
  outline: 2px solid hsl(var(--accent));
  outline-offset: 2px;
}

/* ==========================================================================
   Components — Badges & Pills
   ========================================================================== */

.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 2rem;
  padding: 0.15em 0.6em;
  border-radius: var(--radius-full);
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.badge-grade {
  background: hsl(var(--grade));
  color: hsl(var(--bg));
}

.pill {
  display: inline-block;
  padding: 0.15em 0.55em;
  border-radius: var(--radius-full);
  font-size: 0.7rem;
  border: 1px solid hsl(var(--border));
  color: hsl(var(--text-muted));
}

.weight-badge {
  display: inline-block;
  padding: 0.1em 0.4em;
  border-radius: var(--radius-sm);
  font-size: 0.65rem;
  font-weight: 600;
  color: hsl(var(--text-muted));
  background: hsl(var(--border) / 0.3);
}

/* ==========================================================================
   Layout — Header
   ========================================================================== */

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-bottom: 1.5rem;
}

.header-left { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
.header-right { display: flex; align-items: center; gap: 0.75rem; }

.header-stats {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.8rem;
  color: hsl(var(--text-muted));
}

.theme-toggle {
  background: hsl(var(--card));
  border: 1px solid hsl(var(--border));
  border-radius: var(--radius-sm);
  color: hsl(var(--text-muted));
  padding: 0.4rem 0.6rem;
  cursor: pointer;
  font-size: 0.85rem;
  transition: color 0.2s, border-color 0.2s;
  line-height: 1;
}

.theme-toggle:hover {
  color: hsl(var(--text));
  border-color: hsl(var(--text-muted));
}

/* ==========================================================================
   Layout — Skill Grid (Overview)
   ========================================================================== */

.skill-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1rem;
}

.skill-card-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.skill-card-header h3 { flex: 1; font-size: 1rem; }

.skill-card-score {
  display: flex;
  align-items: baseline;
  gap: 0.35rem;
  margin-bottom: 0.5rem;
}

.skill-card-score .score-value {
  font-size: 1.75rem;
  font-weight: 700;
  letter-spacing: -0.03em;
  line-height: 1;
  color: hsl(var(--grade));
}

.skill-card-score .score-max {
  font-size: 0.85rem;
  color: hsl(var(--text-muted));
}

.skill-card-score .score-bonus {
  font-size: 0.7rem;
  color: hsl(var(--grade-a));
  font-weight: 600;
}

.skill-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 0.3rem;
  margin-top: 0.75rem;
}

/* Score ring SVG */
.score-ring { width: 56px; height: 56px; flex-shrink: 0; }
.score-ring-bg { fill: none; stroke: hsl(var(--border)); stroke-width: 2; }
.score-ring-fill { fill: none; stroke: hsl(var(--grade)); stroke-width: 2.5; transition: stroke-dashoffset 1s cubic-bezier(0.16, 1, 0.3, 1); }
.score-ring-text { fill: hsl(var(--text)); font-size: 8px; font-weight: 700; }

/* ==========================================================================
   Layout — Detail View
   ========================================================================== */

.detail-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
  margin-bottom: 1rem;
}

.detail-header h2 { margin: 0; font-size: 1.3rem; }

.detail-score-display {
  font-size: 2.5rem;
  font-weight: 700;
  letter-spacing: -0.04em;
  line-height: 1;
  color: hsl(var(--grade));
}

.detail-layout {
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 1rem;
  margin-bottom: 1rem;
}

.back-btn {
  background: none;
  border: 1px solid hsl(var(--border));
  border-radius: var(--radius-sm);
  color: hsl(var(--text-muted));
  padding: 0.3rem 0.7rem;
  cursor: pointer;
  font-size: 0.8rem;
  transition: color 0.2s, border-color 0.2s;
}

.back-btn:hover { color: hsl(var(--text)); border-color: hsl(var(--text-muted)); }
.back-btn:focus-visible { outline: 2px solid hsl(var(--accent)); outline-offset: 2px; }

/* ==========================================================================
   Dimension Bars (Detail View)
   ========================================================================== */

.dim-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0;
  border-bottom: 1px solid hsl(var(--border) / 0.3);
  cursor: pointer;
  transition: background 0.15s;
  border-radius: var(--radius-sm);
  padding-left: 0.3rem;
  padding-right: 0.3rem;
}

.dim-row:last-child { border-bottom: none; }
.dim-row:hover { background: hsl(var(--card-hover) / 0.5); }

.dim-label {
  flex: 0 0 180px;
  font-size: 0.82rem;
  color: hsl(var(--text-muted));
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.dim-label .chevron {
  display: inline-block;
  font-size: 0.65rem;
  transition: transform 0.2s;
  color: hsl(var(--text-muted));
}

.dim-label .chevron.open { transform: rotate(90deg); }

.dim-bar-wrap {
  flex: 1;
  height: 8px;
  background: hsl(var(--border) / 0.4);
  border-radius: 4px;
  overflow: hidden;
}

.bar-fill {
  height: 100%;
  border-radius: 4px;
  animation: growBar 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

.dim-score-label {
  flex: 0 0 auto;
  min-width: 3.5rem;
  text-align: right;
  font-size: 0.82rem;
  font-weight: 600;
  white-space: nowrap;
}

/* Collapsible findings */
.dim-findings {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease, padding 0.3s ease;
  padding: 0 0.3rem;
}

.dim-findings.open {
  max-height: 80vh;
  padding: 0.3rem 0.3rem 0.5rem;
}

.dim-findings ul {
  list-style: none;
  padding-left: 0.5rem;
  border-left: 2px solid hsl(var(--border) / 0.4);
}

.dim-findings li {
  font-size: 0.78rem;
  color: hsl(var(--text-muted));
  padding: 0.15rem 0;
  padding-left: 0.5rem;
}

/* ==========================================================================
   Radar Chart (Detail View)
   ========================================================================== */

.radar-container { display: flex; justify-content: center; padding: 1rem 0; }
.radar-label { font-size: 6.5px; fill: hsl(var(--text-muted)); }
.radar-grid { stroke: hsl(var(--border) / 0.4); fill: none; stroke-width: 0.5; }
.radar-axis { stroke: hsl(var(--border) / 0.3); stroke-width: 0.3; }
.radar-polygon-fill { fill: hsl(var(--grade) / 0.15); }
.radar-polygon-stroke { fill: none; stroke: hsl(var(--grade)); stroke-width: 1; }
.radar-dot { fill: hsl(var(--grade)); }

/* ==========================================================================
   Pattern Grid (Detail View)
   ========================================================================== */

.pattern-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.4rem 0.75rem;
}

.pattern-item {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.78rem;
  padding: 0.2rem 0;
}

.pattern-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.pattern-dot.found { background: hsl(var(--grade-a)); }
.pattern-dot.suggested { background: transparent; border: 1.5px solid hsl(var(--grade-c)); }
.pattern-dot.missing { background: hsl(var(--border)); opacity: 0.5; }

.pattern-name.found { color: hsl(var(--text)); }
.pattern-name.suggested { color: hsl(var(--grade-c)); }
.pattern-name.missing { color: hsl(var(--text-muted)); opacity: 0.5; }

/* ==========================================================================
   Process Monitor — Phase Pipeline
   ========================================================================== */

.phase-pipeline {
  display: flex;
  justify-content: center;
  padding: 0.75rem 0 0.25rem;
}

.phase-pipeline svg { overflow: visible; }

/* ==========================================================================
   Process Monitor — Layout
   ========================================================================== */

.process-status-bar {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
  font-size: 0.8rem;
  color: hsl(var(--text-muted));
  margin-top: 0.4rem;
}

.process-layout {
  display: grid;
  grid-template-columns: 1fr 260px;
  gap: 1rem;
  margin-bottom: 1rem;
}

/* ==========================================================================
   Process Monitor — Wave Cards
   ========================================================================== */

.wave-card {
  border: 1px solid hsl(var(--border) / 0.4);
  border-radius: var(--radius-sm);
  padding: 0.65rem 0.85rem;
  margin-bottom: 0.5rem;
  background: hsl(var(--card) / 0.35);
}

.wave-card:last-child { margin-bottom: 0; }

.wave-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.4rem;
}

.wave-card-header h3 { font-size: 0.82rem; font-weight: 600; }

.agent-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.3rem 0;
  font-size: 0.78rem;
}

.agent-row + .agent-row {
  border-top: 1px solid hsl(var(--border) / 0.15);
}

.agent-name {
  flex: 0 0 110px;
  color: hsl(var(--text-muted));
  font-size: 0.76rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.agent-bar-wrap {
  flex: 1;
  height: 6px;
  background: hsl(var(--border) / 0.3);
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}

.agent-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.4s ease;
}

.agent-bar-fill.completed {
  background: hsl(var(--status-completed));
  width: 100%;
}

.agent-bar-fill.active {
  background: hsl(var(--status-active));
  width: 60%;
  animation: shimmer 1.8s ease-in-out infinite;
}

.agent-bar-fill.pending {
  background: hsl(var(--status-pending) / 0.2);
  width: 0%;
}

.agent-bar-fill.failed {
  background: hsl(var(--status-failed));
  width: 100%;
}

.agent-status-icon {
  flex-shrink: 0;
  width: 14px;
  text-align: center;
  font-size: 0.7rem;
  line-height: 1;
}

/* ==========================================================================
   Process Monitor — Metrics Panel
   ========================================================================== */

.metrics-table {
  width: 100%;
  font-size: 0.8rem;
}

.metrics-table tr {
  border-bottom: 1px solid hsl(var(--border) / 0.2);
}

.metrics-table tr:last-child { border-bottom: none; }

.metrics-table td {
  padding: 0.35rem 0;
}

.metrics-table td:first-child {
  color: hsl(var(--text-muted));
  padding-right: 0.5rem;
}

.metrics-table td:last-child {
  text-align: right;
  font-variant-numeric: tabular-nums;
  font-weight: 600;
}

/* ==========================================================================
   Process Monitor — Completed Phases
   ========================================================================== */

.completed-phase-row {
  display: flex;
  align-items: baseline;
  gap: 0.4rem;
  padding: 0.35rem 0;
  font-size: 0.78rem;
  border-bottom: 1px solid hsl(var(--border) / 0.15);
}

.completed-phase-row:last-child { border-bottom: none; }

.cp-check {
  color: hsl(var(--status-completed));
  font-weight: 700;
  flex-shrink: 0;
}

.cp-label { font-weight: 600; flex-shrink: 0; }

.cp-dur {
  color: hsl(var(--text-muted));
  font-size: 0.72rem;
  flex-shrink: 0;
}

.cp-notes {
  color: hsl(var(--text-muted));
  font-size: 0.72rem;
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ==========================================================================
   Process Monitor — Approval Gate
   ========================================================================== */

.approval-lock {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  font-size: 0.72rem;
  color: hsl(var(--grade-c));
  font-weight: 600;
  padding: 0.15em 0.5em;
  border: 1px solid hsl(var(--grade-c) / 0.4);
  border-radius: var(--radius-sm);
  background: hsl(var(--grade-c) / 0.08);
}

/* ==========================================================================
   Animations
   ========================================================================== */

@keyframes growBar { from { width: 0; } }

@keyframes fadeSlideUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 hsl(var(--accent) / 0.4); }
  50% { box-shadow: 0 0 0 8px hsl(var(--accent) / 0); }
}

@keyframes shimmer {
  0%   { opacity: 0.65; width: 35%; }
  50%  { opacity: 1;    width: 75%; }
  100% { opacity: 0.65; width: 35%; }
}

@keyframes pulseDot {
  0%, 100% { r: 10; opacity: 1; }
  50%      { r: 12; opacity: 0.7; }
}

/* App-level crossfade */
#app {
  transition: opacity 0.2s ease, transform 0.2s ease;
}

/* ==========================================================================
   Print Styles
   ========================================================================== */

@media print {
  body::before { display: none; }
  body { padding: 0; background: #fff; color: #111; }
  .card {
    background: #fff;
    backdrop-filter: none;
    box-shadow: none;
    border: 1px solid #ccc;
    break-inside: avoid;
  }
  .skill-card { animation: none; }
  .theme-toggle { display: none; }
  .back-btn { display: none; }
  .bar-fill { animation: none; }
  .agent-bar-fill.active { animation: none; width: 60%; }
}

/* ==========================================================================
   Responsive
   ========================================================================== */

@media (max-width: 768px) {
  .skill-grid { grid-template-columns: 1fr; }
  .detail-layout { grid-template-columns: 1fr; }
  .process-layout { grid-template-columns: 1fr; }
  .pattern-grid { grid-template-columns: repeat(2, 1fr); }
  .dim-label { flex: 0 0 130px; }
  .agent-name { flex: 0 0 85px; }
}

@media (max-width: 480px) {
  body { padding: 0.75rem; }
  .pattern-grid { grid-template-columns: 1fr; }
  .agent-name { flex: 0 0 65px; font-size: 0.7rem; }
}
</style>
</head>
<body>
<main id="app" aria-label="Skill Dashboard" role="main"></main>

<!-- Embedded data — shape auto-detects view mode -->
<script id="data" type="application/json">
{
  "session_id": "sess-a1b2c3d4",
  "skill_name": "example-skill",
  "mode": "create",
  "started_at": "2026-02-17T14:30:00Z",
  "updated_at": "2026-02-17T14:33:22Z",
  "status": "active",
  "phases": [
    {
      "id": "understand",
      "label": "Understand",
      "status": "completed",
      "started_at": "2026-02-17T14:30:00Z",
      "completed_at": "2026-02-17T14:30:12Z",
      "notes": "defined scope, 3 patterns identified",
      "artifacts": []
    },
    {
      "id": "plan",
      "label": "Plan",
      "status": "completed",
      "started_at": "2026-02-17T14:30:12Z",
      "completed_at": "2026-02-17T14:30:20Z",
      "notes": "validated name, classified patterns",
      "artifacts": []
    },
    {
      "id": "scaffold",
      "label": "Scaffold",
      "status": "completed",
      "started_at": "2026-02-17T14:30:20Z",
      "completed_at": "2026-02-17T14:30:22Z",
      "notes": "wagents new skill example-skill",
      "artifacts": []
    },
    {
      "id": "build",
      "label": "Build",
      "status": "active",
      "started_at": "2026-02-17T14:30:22Z",
      "completed_at": null,
      "notes": null,
      "artifacts": []
    },
    {
      "id": "validate",
      "label": "Validate",
      "status": "pending",
      "started_at": null,
      "completed_at": null,
      "notes": null,
      "artifacts": []
    },
    {
      "id": "iterate",
      "label": "Iterate",
      "status": "pending",
      "started_at": null,
      "completed_at": null,
      "notes": null,
      "artifacts": []
    }
  ],
  "waves": [
    {
      "id": "wave-1",
      "label": "Wave 1: Body",
      "phase": "build",
      "status": "completed",
      "agents": [
        {
          "id": "agent-body",
          "task": "Write SKILL.md body",
          "area": "body",
          "status": "completed",
          "started_at": "2026-02-17T14:30:22Z",
          "completed_at": "2026-02-17T14:31:45Z",
          "output_summary": "Wrote main skill body with 6 sections"
        }
      ]
    },
    {
      "id": "wave-2",
      "label": "Wave 2: Parallel",
      "phase": "build",
      "status": "active",
      "agents": [
        {
          "id": "agent-refs",
          "task": "Create reference files",
          "area": "references",
          "status": "active",
          "started_at": "2026-02-17T14:31:46Z",
          "completed_at": null,
          "output_summary": null
        },
        {
          "id": "agent-scripts",
          "task": "Create scripts",
          "area": "scripts",
          "status": "active",
          "started_at": "2026-02-17T14:31:46Z",
          "completed_at": null,
          "output_summary": null
        },
        {
          "id": "agent-tmpl",
          "task": "Create templates",
          "area": "templates",
          "status": "pending",
          "started_at": null,
          "completed_at": null,
          "output_summary": null
        },
        {
          "id": "agent-evals",
          "task": "Create evaluation criteria",
          "area": "evals",
          "status": "pending",
          "started_at": null,
          "completed_at": null,
          "output_summary": null
        }
      ]
    }
  ],
  "plan_approval": {
    "required": false,
    "approved": null,
    "approved_at": null
  },
  "metrics": {
    "files_created": 8,
    "lines_written": 640,
    "patterns_applied": ["dispatch-table", "reference-file-index", "critical-rules", "canonical-vocabulary", "scope-boundaries", "classification-gating", "scaling-strategy", "scripts", "templates"],
    "baseline_score": null,
    "current_score": null,
    "current_grade": null,
    "iteration_count": 0
  },
  "audit": null
}
</script>

<script>
/* ==========================================================================
   Skill Dashboard — Dual-Mode Interactive Report
   ==========================================================================
   Auto-detects view mode from injected JSON shape:
   - data.phases  -> Process Monitor (phase pipeline, waves, agents, metrics)
   - data.skills  -> Audit Overview/Detail (skill cards with scores)
   No external dependencies. ES2020+ syntax. IIFE-encapsulated.
   ========================================================================== */

(function () {
  "use strict";

  /* ======================================================================
     Utilities — XSS Protection & Templating
     ====================================================================== */

  const escH = (str) => {
    if (str == null) return "";
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  };

  const HTML_SAFE = Symbol("html-safe");

  const html = (strings, ...values) => {
    let result = strings[0];
    for (let i = 0; i < values.length; i++) {
      const val = values[i];
      if (val && val[HTML_SAFE]) {
        result += val.toString();
      } else if (Array.isArray(val)) {
        result += val.map(v => (v && v[HTML_SAFE]) ? v.toString() : escH(v)).join("");
      } else {
        result += escH(val);
      }
      result += strings[i + 1];
    }
    const obj = Object.create(null);
    obj[HTML_SAFE] = true;
    obj.toString = () => result;
    return obj;
  };

  const trust = (rawHtml) => {
    const obj = Object.create(null);
    obj[HTML_SAFE] = true;
    obj.toString = () => rawHtml;
    return obj;
  };

  /* ======================================================================
     Utilities — Color, Grade & Time Helpers
     ====================================================================== */

  const gradeVar = (grade) => {
    const map = { A: "--grade-a", B: "--grade-b", C: "--grade-c", D: "--grade-d", F: "--grade-f" };
    return map[grade] ?? "--text-muted";
  };

  const barColor = (pct) => {
    if (pct >= 80) return "hsl(var(--grade-a))";
    if (pct >= 50) return "hsl(var(--grade-c))";
    return "hsl(var(--grade-f))";
  };

  const LABEL_SHORT = {
    "frontmatter": "FM",
    "description": "Desc",
    "dispatch-table": "Disp",
    "body-structure": "Body",
    "pattern-coverage": "Patt",
    "references": "Refs",
    "critical-rules": "Rules",
    "scripts": "Scripts",
    "conciseness": "Conc"
  };

  const ALL_PATTERNS = [
    "dispatch-table", "reference-file-index", "critical-rules",
    "canonical-vocabulary", "scope-boundaries", "classification-gating",
    "scaling-strategy", "state-management", "scripts", "templates",
    "hooks", "progressive-disclosure", "body-substitutions"
  ];

  /** Format duration between two ISO timestamps (or from start to now) */
  const fmtDur = (startIso, endIso) => {
    if (!startIso) return "--";
    const ms = Math.max(0, (endIso ? new Date(endIso) : new Date()) - new Date(startIso));
    const s = Math.floor(ms / 1000);
    if (s < 60) return s + "s";
    const m = Math.floor(s / 60);
    const rs = s % 60;
    if (m < 60) return m + "m" + (rs ? " " + rs + "s" : "");
    return Math.floor(m / 60) + "h " + (m % 60) + "m";
  };

  /** Relative time like "1m ago" */
  const timeAgo = (iso) => {
    if (!iso) return "--";
    const s = Math.max(0, Math.floor((Date.now() - new Date(iso)) / 1000));
    if (s < 60) return s + "s ago";
    const m = Math.floor(s / 60);
    if (m < 60) return m + "m ago";
    return Math.floor(m / 60) + "h ago";
  };

  /* ======================================================================
     State
     ====================================================================== */

  let state = { view: "overview", detailSkill: null, theme: "dark" };
  const expandedDims = new Set();

  /* ======================================================================
     Data Loading & Auto-Detection
     ====================================================================== */

  const app = document.getElementById("app");
  const dataEl = document.getElementById("data");
  const raw = dataEl?.textContent ?? "";
  let data;

  try {
    data = JSON.parse(raw);
  } catch (err) {
    app.innerHTML = html`
      <div class="card" role="alert" style="border: 2px solid hsl(var(--grade-f));">
        <h2 style="color: hsl(var(--grade-f)); margin-bottom: 0.5rem;">JSON Parse Error</h2>
        <p style="margin-bottom: 0.5rem;">${err.message}</p>
        <pre style="white-space: pre-wrap; word-break: break-all; font-size: 0.8rem; color: hsl(var(--text-muted));">${raw}</pre>
      </div>
    `.toString();
    return;
  }

  if (typeof data !== "object" || data === null || Array.isArray(data)) {
    throw new Error("Invalid dashboard data: expected a JSON object");
  }

  const isProcessMode = !!data.phases;
  const isAuditMode = Array.isArray(data.skills);

  const skills = isAuditMode
    ? (data.skills ?? []).slice().sort((a, b) => b.score - a.score)
    : [];

  if (isProcessMode) {
    state.view = "process";
  } else if (isAuditMode) {
    state.view = "overview";
  }

  /* ======================================================================
     Live Polling (Process Monitor)
     ====================================================================== */

  const pollUrl = dataEl?.getAttribute("data-poll-url");
  let pollInterval = null;

  const startPolling = () => {
    if (pollUrl && data.status === "active" && !pollInterval) {
      pollInterval = setInterval(async () => {
        try {
          const resp = await fetch(pollUrl);
          if (resp.ok) {
            data = await resp.json();
            render();
            if (data.status !== "active" && pollInterval) {
              clearInterval(pollInterval);
              pollInterval = null;
            }
          }
        } catch { /* silent — static fallback for file:// */ }
      }, 2000);
    }
  };

  /* ======================================================================
     Navigation & Theme
     ====================================================================== */

  let navTimer = null;

  const navigate = (view, skill = null) => {
    app.style.opacity = "0";
    app.style.transform = "translateY(4px)";
    clearTimeout(navTimer);
    navTimer = setTimeout(() => {
      state = { ...state, view, detailSkill: skill };
      expandedDims.clear();
      render();
      app.style.opacity = "1";
      app.style.transform = "translateY(0)";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }, 200);
  };

  const toggleTheme = () => {
    state = { ...state, theme: state.theme === "dark" ? "light" : "dark" };
    document.documentElement.setAttribute("data-theme", state.theme);
  };

  const toggleDim = (key) => {
    if (expandedDims.has(key)) expandedDims.delete(key);
    else expandedDims.add(key);
    render();
  };

  /* ======================================================================
     Event Delegation
     ====================================================================== */

  app.addEventListener("click", (e) => {
    const target = e.target.closest("[data-action]");
    if (!target) return;

    const action = target.dataset.action;

    if (action === "detail") {
      const skillName = target.dataset.skill;
      if (skillName) navigate("detail", skillName);
    } else if (action === "back") {
      navigate("overview");
    } else if (action === "toggle-theme") {
      toggleTheme();
    } else if (action === "toggle-dim") {
      const dimKey = target.dataset.dimKey;
      if (dimKey) toggleDim(dimKey);
    }
  });

  /* ======================================================================
     Keyboard Navigation
     ====================================================================== */

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && state.view === "detail") {
      navigate("overview");
    }
    if ((e.key === "Enter" || e.key === " ") && document.activeElement?.dataset?.action) {
      e.preventDefault();
      document.activeElement.click();
    }
  });

  /* ======================================================================
     Render — Process Monitor: Header
     ====================================================================== */

  const renderProcessHeader = () => {
    const elapsed = fmtDur(data.started_at, data.status !== "active" ? data.updated_at : null);
    const statusVar = { active: "--status-active", completed: "--status-completed", failed: "--status-failed" }[data.status] ?? "--text-muted";

    return html`
      <header class="header">
        <div class="header-left">
          <h1>Creating: ${data.skill_name}</h1>
          <div class="process-status-bar">
            <span class="pill">Mode: ${data.mode}</span>
            <span class="pill" style="border-color: hsl(var(${statusVar}) / 0.5); color: hsl(var(${statusVar}));">Status: ${data.status}</span>
            <span class="pill">Elapsed: ${elapsed}</span>
          </div>
        </div>
        <div class="header-right">
          <button class="theme-toggle" data-action="toggle-theme" aria-label="Toggle theme" title="Toggle light/dark theme">
            ${state.theme === "dark" ? "\u2600" : "\u263D"}
          </button>
        </div>
      </header>
    `;
  };

  /* ======================================================================
     Render — Audit: Header
     ====================================================================== */

  const renderAuditHeader = () => {
    const n = skills.length;
    const avg = n > 0 ? Math.round(skills.reduce((s, sk) => s + (sk.score / sk.max) * 100, 0) / n) : 0;
    const gen = data.generated ? data.generated.replace("T", " ").replace("Z", " UTC") : "";

    return html`
      <header class="header">
        <div class="header-left">
          <h1>Skill Quality Dashboard</h1>
          <div class="header-stats">
            ${trust(n > 0 ? `<span class="pill">${n} skill${n !== 1 ? "s" : ""}</span>` : "")}
            ${trust(avg > 0 ? `<span class="pill">avg ${avg}%</span>` : "")}
            ${trust(gen ? `<span style="font-size:0.75rem;">${escH(gen)}</span>` : "")}
          </div>
        </div>
        <div class="header-right">
          <button class="theme-toggle" data-action="toggle-theme" aria-label="Toggle theme" title="Toggle light/dark theme">
            ${state.theme === "dark" ? "\u2600" : "\u263D"}
          </button>
        </div>
      </header>
    `;
  };

  /* ======================================================================
     Render — Process Monitor: Phase Pipeline SVG
     ====================================================================== */

  const renderPhasePipeline = () => {
    const phases = data.phases ?? [];
    const n = phases.length;
    if (!n) return trust("");

    const spacing = 64;
    const w = (n - 1) * spacing + 40;
    const h = 56;
    const cy = 20;
    const r = 10;
    const x0 = 20;

    const abbr = { understand: "U", plan: "P", scaffold: "S", build: "B", validate: "V", iterate: "I" };
    let svg = "";

    // Connecting lines
    for (let i = 0; i < n - 1; i++) {
      const lx1 = x0 + i * spacing + r;
      const lx2 = x0 + (i + 1) * spacing - r;
      const done = phases[i].status === "completed";
      svg += `<line x1="${lx1}" y1="${cy}" x2="${lx2}" y2="${cy}" stroke="${done ? "hsl(var(--status-completed))" : "hsl(var(--border))"}" stroke-width="2"${done ? "" : ' stroke-dasharray="4 3"'}/>`;
    }

    // Nodes
    for (let i = 0; i < n; i++) {
      const p = phases[i];
      const cx = x0 + i * spacing;
      const letter = abbr[p.id] ?? p.label.charAt(0);
      let fill, stroke, textFill, extra = "";

      switch (p.status) {
        case "completed":
          fill = "hsl(var(--status-completed))";
          stroke = fill;
          textFill = "hsl(var(--bg))";
          break;
        case "active":
          fill = "hsl(var(--status-active))";
          stroke = fill;
          textFill = "#fff";
          extra = `><animate attributeName="r" values="${r};${r + 2};${r}" dur="2s" repeatCount="indefinite"/`;
          break;
        case "failed":
          fill = "hsl(var(--status-failed))";
          stroke = fill;
          textFill = "#fff";
          break;
        case "skipped":
          fill = "transparent";
          stroke = "hsl(var(--status-skipped))";
          textFill = stroke;
          extra = ` stroke-dasharray="3 2"`;
          break;
        default:
          fill = "transparent";
          stroke = "hsl(var(--border))";
          textFill = "hsl(var(--text-muted))";
      }

      if (p.status === "active") {
        svg += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${fill}" stroke="${stroke}" stroke-width="2"${extra}></circle>`;
      } else {
        svg += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${fill}" stroke="${stroke}" stroke-width="2"${extra}/>`;
      }

      svg += `<text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="central" fill="${textFill}" font-size="8" font-weight="700">${escH(letter)}</text>`;
      svg += `<text x="${cx}" y="${cy + r + 14}" text-anchor="middle" fill="hsl(var(--text-muted))" font-size="8.5">${escH(p.label)}</text>`;

      // Lock icon for unapproved plan phase
      if (p.id === "plan" && data.plan_approval?.required && !data.plan_approval?.approved && p.status !== "completed") {
        svg += `<text x="${cx + r + 2}" y="${cy - r + 1}" font-size="8">&#x1F512;</text>`;
      }
    }

    return trust(`<div class="phase-pipeline"><svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" aria-label="Phase pipeline">${svg}</svg></div>`);
  };

  /* ======================================================================
     Render — Process Monitor: Wave Panel
     ====================================================================== */

  const renderWavePanel = () => {
    const waves = data.waves ?? [];
    if (!waves.length) return html`<p style="color: hsl(var(--text-muted)); font-size: 0.8rem;">No waves dispatched yet.</p>`;

    const activePhase = (data.phases ?? []).find(p => p.status === "active");

    return html`
      ${trust(activePhase ? `
        <div style="margin-bottom: 0.6rem;">
          <h3 style="font-size: 0.92rem; margin-bottom: 0.15rem;">Current Phase: ${escH(activePhase.label)}</h3>
          <span style="font-size: 0.73rem; color: hsl(var(--text-muted));">Started: ${escH(timeAgo(activePhase.started_at))}</span>
        </div>
      ` : "")}
      ${waves.map(wave => {
        const wIcon = { completed: "\u2713", active: "\u25C9", failed: "\u2717", pending: "\u25CB" }[wave.status] ?? "\u25CB";
        const wColor = { completed: "--status-completed", active: "--status-active", failed: "--status-failed", pending: "--text-muted" }[wave.status] ?? "--text-muted";

        return html`
          <div class="wave-card">
            <div class="wave-card-header">
              <h3>${wave.label}</h3>
              ${trust(`<span style="color: hsl(var(${wColor}));">${wIcon}</span>`)}
            </div>
            ${(wave.agents ?? []).map(ag => {
              const aIcon = { completed: "\u2713", active: "\uD83D\uDD35", failed: "\u2717", pending: "\u25CB" }[ag.status] ?? "\u25CB";
              const aColor = { completed: "--status-completed", active: "--status-active", failed: "--status-failed", pending: "--text-muted" }[ag.status] ?? "--text-muted";

              return html`
                <div class="agent-row">
                  <span class="agent-name" title="${ag.task}">${ag.id}</span>
                  <div class="agent-bar-wrap"><div class="agent-bar-fill ${ag.status}"></div></div>
                  ${trust(`<span class="agent-status-icon" style="color: hsl(var(${aColor}));">${aIcon}</span>`)}
                </div>
              `;
            })}
          </div>
        `;
      })}
    `;
  };

  /* ======================================================================
     Render — Process Monitor: Metrics Panel
     ====================================================================== */

  const renderMetrics = () => {
    const m = data.metrics ?? {};
    const pa = (m.patterns_applied ?? []).length;
    const pt = ALL_PATTERNS.length;
    const bl = m.baseline_score != null ? String(m.baseline_score) : "--";
    const cur = m.current_score != null ? String(m.current_score) : "--";
    const gr = m.current_grade ?? "";
    const it = m.iteration_count ?? 0;

    return html`
      <div class="card" style="height: fit-content;">
        <h3 style="margin-bottom: 0.6rem;">Metrics</h3>
        <table class="metrics-table"><tbody>
          <tr><td>Files created</td><td>${String(m.files_created ?? 0)}</td></tr>
          <tr><td>Lines written</td><td>${String(m.lines_written ?? 0)}</td></tr>
          <tr><td>Patterns</td><td>${trust(`${pa}/${pt}`)}</td></tr>
          <tr><td>Baseline</td><td>${bl}</td></tr>
          <tr><td>Current</td><td>${trust(`${escH(cur)}${gr ? " (" + escH(gr) + ")" : ""}`)}</td></tr>
          ${trust(it > 0 ? `<tr><td>Iterations</td><td>${it}</td></tr>` : "")}
        </tbody></table>
      </div>
    `;
  };

  /* ======================================================================
     Render — Process Monitor: Completed Phases
     ====================================================================== */

  const renderCompletedPhases = () => {
    const done = (data.phases ?? []).filter(p => p.status === "completed");
    if (!done.length) return trust("");

    return html`
      <div class="card" style="margin-bottom: 1rem;">
        <h3 style="margin-bottom: 0.4rem;">Completed Phases</h3>
        ${done.map(p => {
          const dur = fmtDur(p.started_at, p.completed_at);
          return html`
            <div class="completed-phase-row">
              ${trust('<span class="cp-check">\u2713</span>')}
              <span class="cp-label">${p.label}</span>
              <span class="cp-dur">(${dur})</span>
              <span class="cp-notes">${trust(p.notes ? " \u2014 " + escH(p.notes) : "")}</span>
            </div>
          `;
        })}
      </div>
    `;
  };

  /* ======================================================================
     Render — Process Monitor: Approval Gate
     ====================================================================== */

  const renderApprovalGate = () => {
    if (!data.plan_approval?.required || data.plan_approval?.approved) return trust("");
    const planPhase = (data.phases ?? []).find(p => p.id === "plan");
    if (!planPhase || planPhase.status === "completed") return trust("");
    return trust(
      `<div style="display: flex; justify-content: center; margin-bottom: 0.75rem;">` +
      `<span class="approval-lock">\uD83D\uDD12 Plan approval required</span>` +
      `</div>`
    );
  };

  /* ======================================================================
     Render — Process Monitor: Full View
     ====================================================================== */

  const renderProcess = () => {
    return html`
      <section aria-label="Process Monitor">
        ${renderApprovalGate()}
        ${trust(
          `<div class="card" style="margin-bottom: 1rem;">${renderPhasePipeline().toString()}</div>` +
          `<div class="process-layout">` +
            `<div class="card">${renderWavePanel().toString()}</div>` +
            renderMetrics().toString() +
          `</div>` +
          renderCompletedPhases().toString()
        )}
      </section>
    `;
  };

  /* ======================================================================
     Render — Audit: Overview
     ====================================================================== */

  const renderScoreRing = (score, max, grade) => {
    const pct = max > 0 ? (score / max) * 100 : 0;
    const circumference = 2 * Math.PI * 16;
    const offset = circumference - (circumference * pct / 100);
    const gVar = gradeVar(grade);

    return trust(`
      <svg class="score-ring" viewBox="-1 -1 38 38" aria-label="Score: ${score}/${max}">
        <circle class="score-ring-bg" cx="18" cy="18" r="16"/>
        <circle class="score-ring-fill" cx="18" cy="18" r="16"
          stroke-dasharray="${circumference.toFixed(2)}"
          stroke-dashoffset="${offset.toFixed(2)}"
          transform="rotate(-90 18 18)"
          style="stroke: hsl(var(${gVar}));"/>
        <text x="18" y="18" text-anchor="middle" dominant-baseline="central"
          class="score-ring-text" style="fill: hsl(var(${gVar}));">${Math.round(pct)}</text>
      </svg>
    `);
  };

  const renderSkillCard = (sk, index) => {
    const pFound = (sk.patterns_found ?? []).length;
    const pTotal = ALL_PATTERNS.length;

    return html`
      <div class="card skill-card" data-grade="${sk.grade}" data-action="detail" data-skill="${sk.skill}"
           style="--i: ${String(index)};" tabindex="0" role="button"
           aria-label="${sk.skill}: grade ${sk.grade}, score ${String(sk.score)} of ${String(sk.max)}">
        <div class="skill-card-header">
          <h3>${sk.skill}</h3>
          <span class="badge badge-grade">${sk.grade}</span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          ${renderScoreRing(sk.score, sk.max, sk.grade)}
          <div>
            <div class="skill-card-score">
              <span class="score-value">${String(sk.score)}</span>
              <span class="score-max">/ ${String(sk.max)}</span>
              ${trust(sk.bonus > 0 ? `<span class="score-bonus">+${sk.bonus}</span>` : "")}
            </div>
            <div style="font-size: 0.75rem; color: hsl(var(--text-muted));">${sk.path ?? ""}</div>
          </div>
        </div>
        <div class="skill-meta">
          <span class="pill">${String(pFound)}/${String(pTotal)} patterns</span>
          ${trust(sk.meta ? `
            <span class="pill">${sk.meta.lines} lines</span>
            <span class="pill">${sk.meta.refs} refs</span>
            <span class="pill">${sk.meta.scripts} scripts</span>
          ` : "")}
        </div>
      </div>
    `;
  };

  const renderOverview = () => {
    if (!skills.length) return html`<p style="color: hsl(var(--text-muted));">No skills data.</p>`;

    return html`
      <section aria-label="Skills Overview">
        <div class="skill-grid">
          ${trust(skills.map((sk, i) => renderSkillCard(sk, i).toString()).join(""))}
        </div>
      </section>
    `;
  };

  /* ======================================================================
     Render — Audit: Detail View
     ====================================================================== */

  const renderRadarChart = (sk) => {
    const dims = sk.dimensions ?? [];
    if (!dims.length) return trust("");

    const cx = 100;
    const cy = 100;
    const maxRadius = 75;
    const n = dims.length;
    const angleStep = (2 * Math.PI) / n;
    const gVar = gradeVar(sk.grade);

    let gridRings = "";
    for (const pct of [0.25, 0.5, 0.75, 1.0]) {
      const r = maxRadius * pct;
      const points = [];
      for (let i = 0; i < n; i++) {
        const angle = -Math.PI / 2 + i * angleStep;
        points.push(`${cx + r * Math.cos(angle)},${cy + r * Math.sin(angle)}`);
      }
      gridRings += `<polygon class="radar-grid" points="${points.join(" ")}"/>`;
    }

    let axisLines = "";
    for (let i = 0; i < n; i++) {
      const angle = -Math.PI / 2 + i * angleStep;
      const x2 = cx + maxRadius * Math.cos(angle);
      const y2 = cy + maxRadius * Math.sin(angle);
      axisLines += `<line class="radar-axis" x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}"/>`;
    }

    const dataPoints = [];
    for (let i = 0; i < n; i++) {
      const dim = dims[i];
      const scorePct = dim.max > 0 ? dim.score / dim.max : 0;
      const r = maxRadius * scorePct;
      const angle = -Math.PI / 2 + i * angleStep;
      dataPoints.push({ x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle) });
    }
    const polyPoints = dataPoints.map(p => `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(" ");

    let dots = "";
    for (const p of dataPoints) {
      dots += `<circle class="radar-dot" cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="2"/>`;
    }

    let labels = "";
    const labelRadius = maxRadius + 14;
    for (let i = 0; i < n; i++) {
      const angle = -Math.PI / 2 + i * angleStep;
      const lx = cx + labelRadius * Math.cos(angle);
      const ly = cy + labelRadius * Math.sin(angle);
      const name = LABEL_SHORT[dims[i].id] || dims[i].id;
      let anchor = "middle";
      if (Math.cos(angle) < -0.1) anchor = "end";
      else if (Math.cos(angle) > 0.1) anchor = "start";
      labels += `<text class="radar-label" x="${lx.toFixed(1)}" y="${ly.toFixed(1)}" text-anchor="${anchor}" dominant-baseline="central">${escH(name)}</text>`;
    }

    return trust(`
      <div class="radar-container" data-grade="${escH(sk.grade)}">
        <svg viewBox="0 0 200 200" width="280" height="280" aria-label="Radar chart for ${escH(sk.skill)}">
          ${gridRings}
          ${axisLines}
          <polygon class="radar-polygon-fill" points="${polyPoints}" style="fill: hsl(var(${gVar}) / 0.15);"/>
          <polygon class="radar-polygon-stroke" points="${polyPoints}" style="stroke: hsl(var(${gVar}));"/>
          ${dots}
          ${labels}
        </svg>
      </div>
    `);
  };

  const renderDimRow = (dim, skillName, index) => {
    const pct = dim.max > 0 ? Math.round((dim.score / dim.max) * 100) : 0;
    const color = barColor(pct);
    const hasFindings = dim.findings?.length > 0;
    const dimKey = `${skillName}:${index}`;
    const isOpen = expandedDims.has(dimKey);

    let findingsHtml = "";
    if (hasFindings) {
      const items = dim.findings.map(f => `<li>${escH(f)}</li>`).join("");
      findingsHtml = `
        <div class="dim-findings ${isOpen ? "open" : ""}">
          <ul>${items}</ul>
        </div>
      `;
    }

    const weightLabel = dim.weight !== 1.0
      ? `<span class="weight-badge">x${dim.weight.toFixed(1)}</span>`
      : "";

    return trust(`
      <div>
        <div class="dim-row" ${hasFindings ? `data-action="toggle-dim" data-dim-key="${escH(dimKey)}"` : ""}
             role="${hasFindings ? "button" : "presentation"}" ${hasFindings ? 'tabindex="0"' : ""}
             aria-expanded="${hasFindings ? isOpen : ""}"
             aria-label="${escH(dim.name)}: ${dim.score}/${dim.max}">
          <span class="dim-label">
            ${hasFindings ? `<span class="chevron ${isOpen ? "open" : ""}">&#9656;</span>` : "<span style='width:0.65rem;display:inline-block;'></span>"}
            ${escH(dim.name)}
            ${weightLabel}
          </span>
          <div class="dim-bar-wrap">
            <div class="bar-fill" style="width: ${pct}%; background: ${color};"></div>
          </div>
          <span class="dim-score-label">${dim.score}/${dim.max}</span>
        </div>
        ${findingsHtml}
      </div>
    `);
  };

  const renderPatternGrid = (sk) => {
    const found = new Set(sk.patterns_found ?? []);
    const suggested = new Set(sk.patterns_suggested ?? []);

    return trust(ALL_PATTERNS.map(p => {
      let dotClass, nameClass;
      if (found.has(p)) {
        dotClass = "found";
        nameClass = "found";
      } else if (suggested.has(p)) {
        dotClass = "suggested";
        nameClass = "suggested";
      } else {
        dotClass = "missing";
        nameClass = "missing";
      }
      return `
        <div class="pattern-item">
          <span class="pattern-dot ${dotClass}"></span>
          <span class="pattern-name ${nameClass}">${escH(p)}</span>
        </div>
      `;
    }).join(""));
  };

  const renderDetail = (skillName) => {
    const sk = skills.find(s => s.skill === skillName);
    if (!sk) {
      return html`
        <div class="card">
          <button class="back-btn" data-action="back">&larr; Back</button>
          <p style="margin-top: 0.5rem; color: hsl(var(--text-muted));">Skill "${skillName}" not found.</p>
        </div>
      `;
    }

    const gVar = gradeVar(sk.grade);
    const dims = sk.dimensions ?? [];

    return html`
      <section aria-label="Skill Detail: ${sk.skill}">
        ${trust(`
          <button class="back-btn" data-action="back" style="margin-bottom: 1rem;">&larr; Back to overview</button>

          <div class="card" data-grade="${escH(sk.grade)}" style="margin-bottom: 1rem;">
            <div class="detail-header">
              <h2 style="margin: 0;">${escH(sk.skill)}</h2>
              <span class="badge badge-grade" style="font-size: 1rem;">${escH(sk.grade)}</span>
              <span class="detail-score-display" style="color: hsl(var(${gVar}));">${sk.score}<span style="font-size: 1rem; font-weight: 400; color: hsl(var(--text-muted));">/${sk.max}</span></span>
              ${sk.bonus > 0 ? `<span style="color: hsl(var(--grade-a)); font-size: 0.85rem; font-weight: 600;">+${sk.bonus} bonus</span>` : ""}
            </div>
            ${sk.path ? `<p style="font-size: 0.8rem; color: hsl(var(--text-muted)); margin-top: 0.3rem;">${escH(sk.path)}</p>` : ""}
          </div>

          <div class="detail-layout">
            <div class="card" data-grade="${escH(sk.grade)}">
              <h3 style="margin-bottom: 0.5rem;">Dimension Radar</h3>
              ${renderRadarChart(sk).toString()}
              ${sk.meta ? `
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; margin-top: 0.5rem;">
                  <span class="pill">${sk.meta.lines} lines</span>
                  <span class="pill">${sk.meta.refs} refs</span>
                  <span class="pill">${sk.meta.scripts} scripts</span>
                </div>
              ` : ""}
            </div>

            <div class="card" data-grade="${escH(sk.grade)}">
              <h3 style="margin-bottom: 0.5rem;">Scoring Dimensions</h3>
              ${dims.map((dim, i) => renderDimRow(dim, sk.skill, i).toString()).join("")}
            </div>
          </div>

          <div class="card" style="margin-bottom: 1rem;" data-grade="${escH(sk.grade)}">
            <h3 style="margin-bottom: 0.75rem;">Pattern Coverage <span style="font-weight: 400; color: hsl(var(--text-muted)); font-size: 0.8rem;">${(sk.patterns_found ?? []).length}/${ALL_PATTERNS.length}</span></h3>
            <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem; font-size: 0.72rem; color: hsl(var(--text-muted));">
              <span><span class="pattern-dot found" style="display: inline-block; vertical-align: middle;"></span> Found</span>
              <span><span class="pattern-dot suggested" style="display: inline-block; vertical-align: middle;"></span> Suggested</span>
              <span><span class="pattern-dot missing" style="display: inline-block; vertical-align: middle;"></span> Missing</span>
            </div>
            <div class="pattern-grid">
              ${renderPatternGrid(sk).toString()}
            </div>
          </div>
        `)}
      </section>
    `;
  };

  /* ======================================================================
     Render — Main Dispatcher
     ====================================================================== */

  const render = () => {
    let content;
    if (state.view === "process") {
      content = html`${renderProcessHeader()}${renderProcess()}`;
    } else if (state.view === "detail" && state.detailSkill) {
      content = html`${renderAuditHeader()}${renderDetail(state.detailSkill)}`;
    } else {
      content = html`${renderAuditHeader()}${renderOverview()}`;
    }
    app.innerHTML = content.toString();
  };

  /* ======================================================================
     Bootstrap
     ====================================================================== */

  document.documentElement.setAttribute("data-theme", state.theme);
  render();
  startPolling();

})();
</script>
</body>
</html>
